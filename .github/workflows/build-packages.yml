name: Build GUI Packages

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          check-latest: true

      - name: Show Python version
        run: |
          python --version
          where python
        shell: cmd

      - name: Build EXE
        run: .\build_witness_signer_windows.bat
        shell: cmd

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: NAIOWitnessSigner-windows
          path: dist/NAIOWitnessSigner.exe
          if-no-files-found: error

  build-macos:
    runs-on: macos-14
    env:
      APPLICATION_P12_BASE64: ${{ secrets.APPLICATION_P12_BASE64 }}
      APPLICATION_P12_PASSWORD: ${{ secrets.APPLICATION_P12_PASSWORD }}
      CODESIGN_IDENTITY: ${{ secrets.CODESIGN_IDENTITY }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      TEAM_ID: ${{ secrets.TEAM_ID }}
      NOTARY_PASSWORD: ${{ secrets.NOTARY_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          check-latest: true

      - name: Show Python version
        run: python --version

      - name: Validate signing/notarization secrets
        run: |
          missing=0
          for key in APPLICATION_P12_BASE64 APPLICATION_P12_PASSWORD CODESIGN_IDENTITY APPLE_ID TEAM_ID NOTARY_PASSWORD; do
            if [ -z "${!key:-}" ]; then
              echo "::error::Missing repository secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Import Apple certificate to temporary keychain
        run: |
          KEYCHAIN_NAME="build.keychain"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 24)"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          KEYCHAIN_PATH="$HOME/Library/Keychains/${KEYCHAIN_NAME}-db"
          if [ ! -f "$KEYCHAIN_PATH" ]; then
            KEYCHAIN_PATH="$HOME/Library/Keychains/${KEYCHAIN_NAME}"
          fi

          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"

          echo "$APPLICATION_P12_BASE64" | base64 --decode > /tmp/application.p12
          security import /tmp/application.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$APPLICATION_P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security \
            -T /usr/bin/xcrun
          rm -f /tmp/application.p12

          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          echo "KEYCHAIN_NAME=$KEYCHAIN_NAME" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Build unsigned app/dmg
        run: |
          chmod +x build_witness_signer_macos.sh
          ./build_witness_signer_macos.sh

      - name: Sign app and dmg
        run: |
          APP_PATH="dist/NAIOWitnessSigner.app"
          DMG_PATH="dist/NAIOWitnessSigner.dmg"
          DMG_ROOT="dist/dmg_root"

          test -d "$APP_PATH"

          echo "[INFO] Signing app bundle..."
          codesign --force --deep --options runtime --timestamp --sign "$CODESIGN_IDENTITY" "$APP_PATH"
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

          echo "[INFO] Rebuilding dmg from signed app..."
          rm -f "$DMG_PATH"
          rm -rf "$DMG_ROOT"
          mkdir -p "$DMG_ROOT"
          cp -R "$APP_PATH" "$DMG_ROOT/"
          ln -s /Applications "$DMG_ROOT/Applications"
          hdiutil create \
            -volname "NAIOWitnessSigner" \
            -srcfolder "$DMG_ROOT" \
            -ov \
            -format UDZO \
            "$DMG_PATH"

          echo "[INFO] Signing dmg..."
          codesign --force --timestamp --sign "$CODESIGN_IDENTITY" "$DMG_PATH"
          codesign --verify --verbose=2 "$DMG_PATH"

      - name: Notarize and staple dmg
        run: |
          DMG_PATH="dist/NAIOWitnessSigner.dmg"
          test -f "$DMG_PATH"

          echo "[INFO] Storing notary credentials..."
          xcrun notarytool store-credentials "AC_NOTARY" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$NOTARY_PASSWORD"

          echo "[INFO] Submitting dmg for notarization..."
          xcrun notarytool submit "$DMG_PATH" \
            --keychain-profile "AC_NOTARY" \
            --wait

          echo "[INFO] Stapling notarization ticket..."
          xcrun stapler staple "$DMG_PATH"
          xcrun stapler validate "$DMG_PATH"
          spctl --assess --type open --context context:primary-signature -vv "$DMG_PATH" || true

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: NAIOWitnessSigner-macos
          path: dist/NAIOWitnessSigner.dmg
          if-no-files-found: error

      - name: Cleanup temporary keychain
        if: always()
        run: |
          if [ -n "${KEYCHAIN_NAME:-}" ]; then
            security delete-keychain "$KEYCHAIN_NAME" || true
          fi

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download windows artifact
        uses: actions/download-artifact@v4
        with:
          name: NAIOWitnessSigner-windows
          path: release-assets

      - name: Download mac artifact
        uses: actions/download-artifact@v4
        with:
          name: NAIOWitnessSigner-macos
          path: release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/NAIOWitnessSigner.exe
            release-assets/NAIOWitnessSigner.dmg
